<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-2xl font-bold mb-4">Admin Dashboard</h1>
  <div class="mb-6 border-b border-gray-300">
    <nav class="flex space-x-6 text-gray-600 text-sm font-medium" id="adminTabs">
      <button onclick="showTab('products')" id="tab-products" class="py-2 border-b-2 border-blue-600 text-blue-600">
        Products
      </button>
      <button onclick="showTab('orders')" id="tab-orders" class="py-2 border-b-2 border-transparent hover:text-blue-600">
        Orders
      </button>

<button onclick="showTab('salespersons')" id="tab-salespersons" class="py-2 border-b-2 border-transparent hover:text-blue-600">
  Salespersons
</button>
<button onclick="showTab('retailers')" id="tab-retailers" class="py-2 border-b-2 border-transparent hover:text-blue-600">
  Retailers
</button>
<button onclick="showTab('companies')" id="tab-companies" class="py-2 border-b-2 border-transparent hover:text-blue-600">
  Companies
</button>
      <button onclick="showTab('sales')" id="tab-sales" class="py-2 border-b-2 border-transparent hover:text-blue-600">
        Sales Summary
      </button>

    </nav>
  </div>

  <!-- Products Tab -->
  <div id="productsTab" class="bg-gray-50 p-6">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-bold">Products</h2>
      <div class="space-x-2">
        <button class="bg-green-600 text-white px-4 py-2 rounded">+ Add Product</button>
	<input type="file" id="bulkUploadInput" accept=".xlsx" class="hidden" />
	<button id="bulkUploadBtn" class="bg-purple-600 text-white px-4 py-2 rounded">Bulk Upload</button>
        <button id="exportCsvBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Export to CSV</button>


      </div>
    </div>
    <table class="min-w-full bg-white shadow rounded overflow-hidden">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-3 text-left">Image</th>
          <th class="p-3 text-left">Name</th>
          <th class="p-3 text-left">Base Price</th>
          <th class="p-3 text-left">Min Retail Price</th>
          <th class="p-3 text-left">Company</th>
          <th class="p-3 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="productTable" class="divide-y divide-gray-200"></tbody>
    </table>
  </div>
<div id="ordersTab" class="hidden">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-bold">Orders</h2>
<!-- Notification Bell -->
  <div class="flex items-center space-x-4">
    <!-- ✅ Create Order Button -->
    <button onclick="openCreateOrderModal()" 
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">
      Create New Order
    </button>
<button id="notificationBell" class="relative">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 hover:text-blue-600" fill="none"
    viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
      d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002
         6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67
         6.165 6 8.388 6 11v3.159c0 .538-.214
         1.055-.595 1.436L4 17h5m6 0v1a3 3 0
         11-6 0v-1m6 0H9" />
  </svg>
  <span id="notificationDot"
    class="hidden absolute top-0 right-0 inline-block w-2 h-2 bg-red-500 rounded-full"></span>
</button>

<!-- Notification Dropdown -->
<div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white shadow-lg rounded-lg border z-50">
  <ul id="notificationList" class="max-h-60 overflow-y-auto text-sm text-gray-700">
    <!-- Notifications will be injected here -->
  </ul>
</div>
</div>
</div>
<div class="mb-4 flex flex-wrap items-end gap-4">
  <!-- Customer Filter -->
  <div class="relative w-full sm:w-[400px]">
    <label class="text-sm font-medium text-gray-700">Customer:</label>
    <div
      id="customerMultiSelect"
      class="border rounded p-2 mt-1 bg-white min-h-[42px] flex flex-wrap gap-1 cursor-text"
      onclick="toggleCustomerDropdown(true)"
    >
      <input
        type="text"
        id="customerSearchInput"
        class="outline-none flex-1 min-w-[100px]"
        placeholder="Search customers..."
        oninput="filterCustomerList()"
      />
    </div>

    <div
      id="customerDropdown"
      class="absolute z-10 bg-white border border-gray-300 rounded w-full mt-1 max-h-48 overflow-y-auto shadow hidden"
    >
      <!-- Filtered customer options will appear here -->
    </div>
  </div>

  <!-- Status Filter -->
<div class="flex flex-col">
  <label class="text-sm font-medium text-gray-700">Status:</label>
  <select id="statusFilter" onchange="fetchOrders()" class="border p-2 rounded w-48 mt-1">
    <option value="">All Orders</option>
    <option value="Pending">Pending</option>
    <option value="Fulfilled">Fulfilled</option>
    <option value="Cancelled">Cancelled</option>
  </select>
</div>
<div class="flex flex-col">
  <label class="text-sm font-medium text-gray-700">Order Date:</label>
  <div class="flex items-center gap-2 mt-1">
    <input
      type="date"
      id="startDateFilter"
      class="border p-2 rounded"
      onchange="fetchOrders()"
    />
    <span>-</span>
    <input
      type="date"
      id="endDateFilter"
      class="border p-2 rounded"
      onchange="fetchOrders()"
    />
  </div>
</div>

</div>

    <div id="ordersTableBody" class="space-y-4"></div>
  </div>
</div>
  <!-- Sales Summary Tab -->
  <div id="salesTab" class="hidden">
    <h2 class="text-xl font-semibold mb-4">Sales Summary</h2>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
      <div class="bg-white p-4 rounded shadow text-center">
        <div class="text-sm text-gray-500">Total Sales</div>
        <div id="totalSales" class="text-xl font-semibold mt-1">₹0</div>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <div class="text-sm text-gray-500">Total Orders</div>
        <div id="totalOrders" class="text-xl font-semibold mt-1">0</div>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <div class="text-sm text-gray-500">Total Customers</div>
        <div id="totalCustomers" class="text-xl font-semibold mt-1">0</div>
      </div>
<div id="chartWrapper" style="position: relative; width: 800px; max-width: 100%;">
  <canvas id="salesSummaryChart" width="800" height="400"></canvas>

  <select id="kpiSelector" style="
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
    background-color: rgba(255, 255, 255, 0.9);
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #ccc;
  ">
    <option value="avgSalesPerOrder">Avg Sales per Order</option>
    <option value="totalSales">Total Sales</option>
    <option value="totalOrders">Total Orders</option>
    <option value="totalCustomers">Total Customers</option>
  </select>
</div>




    </div>
  </div>
<!-- Salespersons Tab -->
<div id="salespersonsTab" class="hidden p-6 bg-gray-50">
  <h2 class="text-xl font-bold mb-4">Manage Salespersons</h2>
  <button onclick="openModal('addSalespersonModal')" class="bg-green-600 text-white px-4 py-2 rounded">+ Add Salesperson</button>

  <table class="min-w-full bg-white shadow rounded overflow-hidden mt-4">
    <thead class="bg-gray-200">
      <tr>
        <th class="p-3 text-left">Name</th>
        <th class="p-3 text-left">Email</th>
        <th class="p-3 text-left">Assigned Retailers</th>
        <th class="p-3 text-left">Actions</th>
      </tr>
    </thead>
    <tbody id="salespersonTable" class="divide-y divide-gray-200"></tbody>
  </table>
</div>
<!-- Retailers Tab -->
<div id="retailersTab" class="hidden p-6 bg-gray-50">
  <div class="flex justify-between items-center mb-4">
    <!-- Left side: title + buttons -->
    <div class="flex items-center gap-3">
      <h2 class="text-xl font-bold">Manage Retailers</h2>
      <button onclick="openAddRetailerModal()" class="bg-green-600 text-white px-4 py-2 rounded">
        + Add Retailer
      </button>
      <button onclick="openBulkReassignModal()" class="bg-blue-600 text-white rounded px-4 py-2">
        Reassign Retailers
      </button>
    </div>

    <!-- Right side: Area Filter -->
    <div class="relative w-full sm:w-[300px]">
      <label class="text-sm font-medium text-gray-700">Area:</label>
      <div
        id="areaMultiSelect"
        class="border rounded p-2 mt-1 bg-white min-h-[42px] flex flex-wrap gap-1 cursor-text"
        onclick="toggleAreaDropdown(true)"
      >
        <input
          type="text"
          id="areaSearchInput"
          class="outline-none flex-1 min-w-[100px]"
          placeholder="Search areas..."
          oninput="filterAreaList()"
        />
      </div>

      <div
        id="areaDropdown"
        class="absolute z-10 bg-white border border-gray-300 rounded w-full mt-1 max-h-48 overflow-y-auto shadow hidden"
      >
        <!-- Filtered area options will appear here -->
      </div>
    </div>
  </div>

  <!-- Retailers Table -->
  <table class="min-w-full bg-white shadow rounded overflow-hidden mt-4">
    <thead class="bg-gray-200">
      <tr>
        <th class="p-3 text-left">Name</th>
        <th class="p-3 text-left">Contact</th>
        <th class="p-3 text-left">Email</th>
        <th class="p-3 text-left">Retailer ID</th>
        <th class="p-3 text-left">Salesperson</th>
        <th class="p-3 text-left">Actions</th>
      </tr>
    </thead>
    <tbody id="retailerTable" class="divide-y divide-gray-200"></tbody>
  </table>
</div>


<!-- Companies Tab -->
<div id="companiesTab" class="hidden p-6 bg-gray-50">
  <h2 class="text-xl font-bold mb-4">Manage Companies</h2>
  <button onclick="openModal('addCompanyModal')" class="bg-green-600 text-white px-4 py-2 rounded">+ Add Company</button>
  <table class="min-w-full bg-white shadow rounded overflow-hidden mt-4">
    <thead class="bg-gray-200">
      <tr>
        <th class="p-3 text-left">Company Name</th>
        <th class="p-3 text-left">Logo</th>
        <th class="p-3 text-left">Actions</th>
      </tr>
    </thead>
    <tbody id="companyTable" class="divide-y divide-gray-200"></tbody>
  </table>
</div>


  <script>
let companyNameToId = {};

let allCustomers = [];
let selectedCustomers = [];
let currentEditOrder = null;
let allProductsList = [];

async function loadCustomerFilter() {
  try {
    const res = await fetch("https://baba-merchant-store.onrender.com/api/admin/customers");
    allCustomers = await res.json();
    renderCustomerOptions(allCustomers);
  } catch (err) {
    console.error("Failed to load customers:", err);
  }
}

function renderCustomerOptions(customers) {
  const dropdown = document.getElementById("customerDropdown");
  dropdown.innerHTML = "";

  customers.forEach(c => {
    if (selectedCustomers.some(sc => sc.customer_id === c.customer_id)) return;

    const option = document.createElement("div");
    option.className = "px-3 py-2 cursor-pointer hover:bg-gray-100 text-sm";
    option.textContent = c.name;
    option.onclick = () => {
      selectedCustomers.push(c);
      document.getElementById("customerSearchInput").value = "";
      renderSelectedTags();
      renderCustomerOptions(allCustomers);
      fetchOrders();
    };
    dropdown.appendChild(option);
  });
}

function renderSelectedTags() {
  const container = document.getElementById("customerMultiSelect");
  const input = document.getElementById("customerSearchInput");

  container.innerHTML = "";
  selectedCustomers.forEach(c => {
    const tag = document.createElement("span");
    tag.className = "bg-blue-100 text-blue-700 text-sm px-2 py-1 rounded flex items-center gap-1";
    tag.textContent = c.name;

    const removeBtn = document.createElement("span");
    removeBtn.className = "cursor-pointer ml-1 font-bold";
    removeBtn.textContent = "×";
    removeBtn.onclick = () => {
      selectedCustomers = selectedCustomers.filter(sc => sc.customer_id !== c.customer_id);
      renderSelectedTags();
      renderCustomerOptions(allCustomers);
      fetchOrders();
    };

    tag.appendChild(removeBtn);
    container.appendChild(tag);
  });

  container.appendChild(input);
}

function filterCustomerList() {
  const term = document.getElementById("customerSearchInput").value.toLowerCase();
  const filtered = allCustomers.filter(c =>
    c.name.toLowerCase().includes(term) &&
    !selectedCustomers.some(sc => sc.customer_id === c.customer_id)
  );
  renderCustomerOptions(filtered);
}

function toggleCustomerDropdown(forceOpen = false) {
  const dropdown = document.getElementById("customerDropdown");
  if (forceOpen) {
    dropdown.classList.remove("hidden");
  } else {
    dropdown.classList.toggle("hidden");
  }
}

// Close dropdown if clicked outside
document.addEventListener("click", (e) => {
  const input = document.getElementById("customerSearchInput");
  const dropdown = document.getElementById("customerDropdown");
  const container = document.getElementById("customerMultiSelect");

  if (!container.contains(e.target) && !dropdown.contains(e.target)) {
    dropdown.classList.add("hidden");
  }
});


async function loadCompanyMap() {
  try {
    const res = await fetch("https://baba-merchant-store.onrender.com/api/companies");
    const companies = await res.json();

    companyNameToId = {};
    companies.forEach(c => {
      companyNameToId[c.name.trim().toLowerCase()] = c.id;
    });
  } catch (err) {
    alert("Failed to load company list.");
    console.error(err);
  }
}
    function showTab(tabName) {
      const tabs = ['products', 'orders', 'sales', 'salespersons', 'retailers', 'companies'];
      tabs.forEach(name => {
        const tab = document.getElementById(`${name}Tab`);
        const button = document.getElementById(`tab-${name}`);
        if (tab) tab.classList.add('hidden');
        if (button) {
          button.classList.remove('border-blue-600', 'text-blue-600');
          button.classList.add('border-transparent');
        }
      });



      const activeTab = document.getElementById(`${tabName}Tab`);
      const activeButton = document.getElementById(`tab-${tabName}`);
      if (activeTab) activeTab.classList.remove('hidden');
      if (activeButton) {
        activeButton.classList.add('border-blue-600', 'text-blue-600');
        activeButton.classList.remove('border-transparent');
      }

      if (tabName === 'sales') {
        fetchSalesSummary();
      } else if (tabName === 'orders') {
 loadCustomerFilter();
        fetchOrders();
  if (!window.ordersPolling) {
    window.ordersPolling = setInterval(checkNewOrders, 30000);
  }
      } else if (tabName === 'products') {
        fetchProducts();
      }
    }

    function fetchProducts() {
      document.getElementById("productTable").innerHTML = `<tr><td colspan='6' class='p-4 text-center text-gray-500'>Fetching products...</td></tr>`;
    }

    function fetchOrders() {
      document.getElementById("ordersTableBody").innerHTML = `<div class='text-gray-500 text-center'>Loading orders...</div>`;
    }

    function fetchSalesSummary() {
      document.getElementById("totalSales").textContent = `₹123456`;
      document.getElementById("totalOrders").textContent = 42;
      document.getElementById("totalCustomers").textContent = 17;
    }

document.getElementById("bulkUploadBtn").addEventListener("click", () => {
  document.getElementById("bulkUploadInput").click();
});

document.getElementById("bulkUploadInput").addEventListener("change", async (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = async (e) => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(sheet);

    const products = json.map(row => {
      const name = row.name;
      const price = parseFloat(row.price);
      const base_price = parseFloat(row.base_price);
      const image_url = row.image_url || "";
      const companyName = row.company_name?.trim().toLowerCase();
      const company_id = companyNameToId[companyName];
      const min_retail_price = parseFloat(row.min_retail_price);
      const hsn = row.hsn;
      const cgst = parseFloat(row.cgst);
      const sgst = parseFloat(row.sgst);
      const cess = parseFloat(row.cess);

      if (!company_id) {
        throw new Error(`Company '${row.company_name}' not found in system.`);
      }

      return { name, price, base_price, image_url, company_id, min_retail_price, hsn, cgst, sgst,cess };
    });

    // Send to backend
    try {
      const res = await fetch("https://baba-merchant-store.onrender.com/api/admin/products/bulk", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ products }),
      });

      if (!res.ok) throw new Error("Bulk upload failed");
      alert("Bulk upload successful!");
      fetchProducts();
    } catch (err) {
      console.error(err);
      alert("Error uploading products: " + err.message);
    }
  };

  reader.readAsArrayBuffer(file);
});


    // Initialize with products tab
    document.addEventListener("DOMContentLoaded", () => {
loadCompanyMap();

    showTab("products");
  document.getElementById("exportCsvBtn").addEventListener("click", async () => {
    try {
      const res = await fetch("https://baba-merchant-store.onrender.com/api/admin/products");
      const products = await res.json();

      if (!Array.isArray(products) || products.length === 0) {
        alert("No products to export.");
        return;
      }

      const csvRows = [];

      // Header
      csvRows.push("ID,Name,Price,Company,Image URL");

      // Data
      products.forEach(p => {
        const row = [
          p.id,
          `"${p.name}"`,
          p.price,
          `"${p.company_name}"`,
          `"${p.image_url || ""}"`
        ];
        csvRows.push(row.join(","));
      });

      const csvContent = csvRows.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "products.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    } catch (err) {
      console.error("CSV Export failed:", err);
      alert("Failed to export products to CSV.");
    }
  });
    });
async function fetchProducts() {
  const tableBody = document.getElementById("productTable");
  tableBody.innerHTML = `<tr><td colspan='6' class='p-4 text-center text-gray-500'>Fetching products...</td></tr>`;

  try {
    const res = await fetch("https://baba-merchant-store.onrender.com/api/admin/products");
    const products = await res.json();

    if (!Array.isArray(products) || products.length === 0) {
      tableBody.innerHTML = `<tr><td colspan='6' class='p-4 text-center text-gray-500'>No products found.</td></tr>`;
      return;
    }

    tableBody.innerHTML = "";
    products.forEach(product => {
  console.log("Rendering product row for:", product);
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="p-3"><img src="${product.image_url}" alt="${product.name}" class="w-12 h-12 object-cover rounded" /></td>
        <td class="p-3">${product.name}</td>
        <td class="p-3">₹${product.base_price}</td> <!-- NEW -->
        <td class="p-3">₹${product.min_retail_price}</td>
        <td class="p-3">${product.company_name}</td>
        <td class="p-3 space-x-2">
          <button class="text-blue-600 hover:underline" onclick="editProduct('${product.id}')">Edit</button>
          <button class="text-red-600 hover:underline" onclick="deleteProduct('${product.id}')">Delete</button>
        </td>
      `;
      tableBody.appendChild(row);
    });
  } catch (error) {
    tableBody.innerHTML = `<tr><td colspan='6' class='p-4 text-center text-red-500'>Error loading products.</td></tr>`;
  }
}

async function fetchOrders() {
  const container = document.getElementById("ordersTableBody");
  container.innerHTML = `<div class='text-gray-500 text-center'>Loading orders...</div>`;

  try {
    const customerFilter = selectedCustomers.map(c => c.customer_id);
 // assume this is set from your multiselect filter
    const statusFilter = document.getElementById("statusFilter").value;
const startDate = document.getElementById('startDateFilter').value;
const endDate = document.getElementById('endDateFilter').value;


    let url = `https://baba-merchant-store.onrender.com/api/admin/orders`;

    const params = new URLSearchParams();
    if (customerFilter.length > 0) {
      params.append("customer_ids", customerFilter.join(","));
    }
    if (statusFilter) {
      params.append("status", statusFilter);
    }
if (startDate) params.append("start_date", startDate);
if (endDate) params.append("end_date", endDate);

    if ([...params].length > 0) {
      url += "?" + params.toString();
    }

    const res = await fetch(url);
    const orders = await res.json();
    console.log("Orders API Response:", orders);
    if (!Array.isArray(orders) || orders.length === 0) {
      container.innerHTML = `<div class='text-center text-gray-500'>No orders found.</div>`;
      return;
    }

    container.innerHTML = "";
    orders.forEach(order => {
      const card = document.createElement("div");
      card.className = "bg-white p-4 rounded shadow";


      const itemsList = order.items.map(item => `
  <li class="flex items-center gap-4 mb-1">
    <span class="flex-1">${item.product_name} × ${item.quantity}</span>
    <span class="text-gray-500">₹${item.base_price}</span>
    <input 
      type="number" 
      step="0.01"
      max="${item.min_retail_price}"
      value="${item.negotiated_price ?? 0}" 
      class="border rounded px-2 py-1 w-20 text-sm"
      onchange="updateNegotiatedPrice(${item.order_item_id}, this.value)"

    />
  </li>
`).join("");

      const orderDate = new Date(order.created_at);
      const formattedDate = orderDate.toLocaleString('en-IN', {
        dateStyle: 'medium',
        timeStyle: 'short'
      });

card.innerHTML = `
  <div class="flex justify-between items-center mb-2">
    <div>
      <strong>Order #${order.order_id}</strong> by ${order.customer_name} (${order.customer_id})<br>
      <span class="text-sm text-gray-500">${formattedDate}</span>
    </div>
<div class="flex items-center space-x-3">
      <button class="edit-order-btn bg-yellow-500 text-white px-3 py-1 rounded text-xs" onclick="openEditOrderModal(${order.order_id})">
      Edit Order
    </button>
  <span 
    class="text-sm px-2 py-1 rounded cursor-pointer font-semibold ${getStatusClass(order.status)}"
    onclick="showStatusOptions(${order.order_id}, this)"
  >
    ${order.status}
  </span>
  
  <!-- Invoice Icon with Tooltip -->
  <div class="relative group">
    <svg xmlns="http://www.w3.org/2000/svg" 
         class="h-5 w-5 text-blue-600 cursor-pointer hover:text-blue-800" 
         fill="none" 
         viewBox="0 0 24 24" 
         stroke="currentColor"
         onclick="generateInvoice(${order.order_id})">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
            d="M9 12h6m-6 4h6M9 8h6m-7 0H5m7-4h2a2 2 0 012 2v14l-4-4-4 4V6a2 2 0 012-2z"/>
    </svg>

    <!-- Tooltip -->
    <span class="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 
                 bg-gray-800 text-white text-xs rounded px-2 py-1 
                 opacity-0 group-hover:opacity-100 transition-opacity">
      Generate invoice
    </span>
  </div>
</div>

  </div>

        <ul class="text-sm text-gray-700 ml-4 list-disc">${itemsList}</ul>
        <div class="mt-2 text-right font-semibold">Total: ₹${order.total_value}</div>
<div class="mt-4 border-t pt-2">
  <label class="block text-sm font-medium text-gray-700 mb-1">Internal Notes:</label>
  <textarea 
    id="orderNotes-${order.order_id}" 
    class="w-full border rounded p-2 text-sm"
    placeholder="Add notes about this order..."
  >${order.notes || ""}</textarea>
  <div class="text-right mt-2">
    <button 
      class="bg-blue-600 text-white text-sm px-3 py-1 rounded"
      onclick="saveOrderNote(${order.order_id})"
    >Save Note</button>
  </div>
</div>
      `;
      container.appendChild(card);
    });
  } catch (error) {
    container.innerHTML = `<div class='text-center text-red-500'>Failed to load orders.</div>`;
  }
}

async function updateNegotiatedPrice(order_item_id, finalPrice, minPrice) {
  finalPrice = parseFloat(finalPrice);

  if (finalPrice < minPrice) {
    alert(`Final Price cannot be more than ₹${minPrice} for this product.`);
    return;
  }
  if (finalPrice > 1000000000) {
    alert("Check Final Price.");
    return;
  }

  try {
    const res = await fetch(`https://baba-merchant-store.onrender.com/api/admin/order-items/${order_item_id}/discount`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ negotiated_price: finalPrice })
    });

    if (!res.ok) throw new Error("Failed to update Final Price");
    console.log(`Updated negotiated_price for order_item_id ${order_item_id}`);
  } catch (err) {
    alert("Error updating discount: " + err.message);
  }
}




async function fetchSalesSummary() {
  try {
    const res = await fetch("https://baba-merchant-store.onrender.com/api/admin/sales-summary");
    const summary = await res.json();

    document.getElementById("totalSales").textContent = `₹${summary.total_revenue}`;
    document.getElementById("totalOrders").textContent = summary.total_orders;
    document.getElementById("totalCustomers").textContent = summary.unique_customers;
  } catch (error) {
    document.getElementById("totalSales").textContent = "₹0";
    document.getElementById("totalOrders").textContent = "0";
    document.getElementById("totalCustomers").textContent = "0";
  }
}
// Show Add Product Modal
document.querySelector(".bg-green-600").addEventListener("click", () => {
  openProductModal("add");
});

async function loadCompaniesDropdown(selectedId = "") {
console.log("loadCompaniesDown called with selectedId:", selectedId);
  try {
    const res = await fetch("https://baba-merchant-store.onrender.com/api/companies");
    const companies = await res.json();
    console.log("Fetched companies:", companies);
    const select = document.getElementById("productCompany");
    console.log("Select element:", select);
    select.innerHTML = `<option value="">Select a company</option>`; // reset

    companies.forEach(c => {
      const option = document.createElement("option");
      option.value = c.id;
      option.textContent = c.name;
      if (c.id === selectedId) option.selected = true;
      select.appendChild(option);
    });
  } catch (err) {
    alert("Failed to load companies.");
  }
}

function getStatusClass(status) {
  switch (status) {
    case 'Pending':
      return 'bg-yellow-100 text-yellow-800 border border-yellow-300';
    case 'Fulfilled':
      return 'bg-green-100 text-green-800 border border-green-300';
    case 'Cancelled':
      return 'bg-red-100 text-red-800 border border-red-300';
    default:
      return 'bg-gray-200 text-gray-700';
  }
}
function showStatusOptions(orderId, tagElement) {
  const dropdown = document.createElement("select");
  dropdown.className = "text-sm border rounded px-2 py-1";
  const statuses = ["Pending", "Fulfilled", "Cancelled"];

  statuses.forEach(status => {
    const option = document.createElement("option");
    option.value = status;
    option.textContent = status;
    if (tagElement.textContent === status) option.selected = true;
    dropdown.appendChild(option);
  });

  tagElement.replaceWith(dropdown);

  dropdown.addEventListener("change", async () => {
    const newStatus = dropdown.value;

    try {
      const res = await fetch(`https://baba-merchant-store.onrender.com/api/admin/orders/${orderId}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus })
      });

      if (!res.ok) throw new Error("Failed to update status");

      // Replace dropdown with new status tag
      const newTag = document.createElement("span");
      newTag.className = `text-sm px-2 py-1 rounded cursor-pointer font-semibold ${getStatusClass(newStatus)}`;
      newTag.textContent = newStatus;
      newTag.onclick = () => showStatusOptions(orderId, newTag);

      dropdown.replaceWith(newTag);
    } catch (err) {
      alert("Failed to update status: " + err.message);
    }
  });
}

async function openProductModal(mode, product = {}) {
  document.getElementById("productModal").classList.remove("hidden");
  document.getElementById("productModalTitle").textContent = mode === "edit" ? "Edit Product" : "Add Product";

  // Reset or populate form
  document.getElementById("productId").value = product.id || "";
console.log("Setting productId:", product.id);

  document.getElementById("productName").value = product.name || "";
  document.getElementById("productBasePrice").value = product.base_price || "";
  document.getElementById("productMinRetailPrice").value = product.min_retail_price || "";
  document.getElementById("productHSN").value = product.hsn || "";
  document.getElementById("productCGST").value = product.cgst || "";
  document.getElementById("productSGST").value = product.sgst || "";
  document.getElementById("productCess").value = product.cess || "";
  document.getElementById("productImage").value = product.image_url || "";
console.log("Opening product modal, loading companies...");
await loadCompaniesDropdown(product.company_id || "");
}

function closeProductModal() {
  document.getElementById("productModal").classList.add("hidden");
}

// Handle Form Submit
document.addEventListener("DOMContentLoaded", () => {

  document.getElementById("productForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const id = document.getElementById("productId").value;
    console.log("Submitting product with id:", id);

    const name = document.getElementById("productName").value;
    const base_price = parseFloat(document.getElementById("productBasePrice").value);
    const min_retail_price = parseFloat(document.getElementById("productMinRetailPrice").value);
    const company_id = document.getElementById("productCompany").value;
    const image_url = document.getElementById("productImage").value;
    const hsn= document.getElementById('productHSN').value;
    const cgst= parseFloat(document.getElementById('productCGST').value);
    const sgst= parseFloat(document.getElementById('productSGST').value);
    const cess= parseFloat(document.getElementById('productCess').value);

    const payload = { name, image_url, company_id, base_price, min_retail_price, hsn, cgst, sgst, cess};

    try {
      const res = await fetch(id ? `https://baba-merchant-store.onrender.com/api/admin/products/${id}` : "https://baba-merchant-store.onrender.com/api/admin/products", {
        method: id ? "PUT" : "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) throw new Error("Failed to save product");

      closeProductModal();
      console.log("Saving product:", id, payload);

      fetchProducts();
    } catch (err) {
      alert("Error: " + err.message);
    }
  });

});

// Edit Product
function editProduct(id) {
  fetch(`https://baba-merchant-store.onrender.com/api/admin/products/${id}`)
    .then(res => res.json())
    .then(product => {
      openProductModal("edit", product);
    });
}

// Delete Product
let deleteProductId = null;

function deleteProduct(id) {
  deleteProductId = id;
  document.getElementById("deleteModal").classList.remove("hidden");
}

function closeDeleteModal() {
  deleteProductId = null;
  document.getElementById("deleteModal").classList.add("hidden");
}

async function confirmDeleteProduct() {
  if (!deleteProductId) return;
  try {
    const res = await fetch(`https://baba-merchant-store.onrender.com/api/admin/products/${deleteProductId}`, { method: "DELETE" });
    if (!res.ok) throw new Error("Failed to delete");

    closeDeleteModal();
    fetchProducts();
  } catch (err) {
    alert("Error: " + err.message);
  }
}
let lastSeenOrderTime = localStorage.getItem('lastSeenOrderTime')
  ? parseInt(localStorage.getItem('lastSeenOrderTime'), 10)
  : null;


async function checkNewOrders() {
  try {
    const res = await fetch(`https://baba-merchant-store.onrender.com/api/admin/orders`);
    const orders = await res.json();

    if (Array.isArray(orders) && orders.length > 0) {
      const newOrders = orders.filter(o => {
        const orderTime = new Date(o.created_at).getTime();
        return !lastSeenOrderTime || orderTime > lastSeenOrderTime;
      });

      if (newOrders.length > 0) {
        document.getElementById('notificationDot').classList.remove('hidden');
        window.pendingOrders = newOrders; // Store in memory to show in dropdown
      }
    }
  } catch (err) {
    console.error("Error checking new orders:", err);
  }
}


// Start polling as soon as the dashboard loads
document.addEventListener("DOMContentLoaded", () => {
  checkNewOrders(); // First check
  setInterval(checkNewOrders, 30000); // Every 30s
});
document.getElementById('notificationBell').addEventListener('click', () => {
  const dot = document.getElementById('notificationDot');
  const dropdown = document.getElementById('notificationDropdown');

  // Toggle dropdown visibility
  dropdown.classList.toggle('hidden');

  if (window.pendingOrders && window.pendingOrders.length > 0) {
    const list = window.pendingOrders
      .map(o => `<div class="p-2 border-b">New order from ${o.customer_name}</div>`)
      .join('');
    document.getElementById('notificationList').innerHTML = list;

    const latestTime = Math.max(...window.pendingOrders.map(o => new Date(o.created_at).getTime()));
    lastSeenOrderTime = latestTime;
    localStorage.setItem('lastSeenOrderTime', latestTime);

    window.pendingOrders = [];
  } else {
    document.getElementById('notificationList').innerHTML = `<div class="p-2">No new orders</div>`;
  }

  // Hide red dot after opening
  dot.classList.add('hidden');
});


document.addEventListener('click', (e) => {
  const bell = document.getElementById('notificationBell');
  const dropdown = document.getElementById('notificationDropdown');
  if (!bell.contains(e.target) && !dropdown.contains(e.target)) {
    dropdown.classList.add('hidden');
  }
});


document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("saveEditSalespersonBtn")
          .addEventListener("click", saveEditSalesperson);
});

async function saveOrderNote(orderId) {
  const note = document.getElementById(`orderNotes-${orderId}`).value.trim();
  try {
    const res = await fetch(`https://baba-merchant-store.onrender.com/api/admin/orders/${orderId}/note`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ note })
    });

    if (!res.ok) throw new Error("Failed to save note");
    alert("Note saved successfully!");
  } catch (err) {
    alert("Error saving note: " + err.message);
  }
}

function generateInvoice(orderId) {
  fetch(`https://baba-merchant-store.onrender.com/api/admin/orders/${orderId}/invoice`)
    .then(response => {
      if (!response.ok) throw new Error("Failed to generate invoice");
      return response.blob();
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `invoice_order_${orderId}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    })
    .catch(err => {
      console.error("Error generating invoice:", err);
      alert("Error generating invoice. Please try again.");
    });
}

// Open Edit Order Modal, fetch order details, render products
async function openEditOrderModal(order_id) {
  const res = await fetch(`https://baba-merchant-store.onrender.com/api/admin/orders/${order_id}`);
  const order = await res.json();
  currentEditOrder = JSON.parse(JSON.stringify(order));
  renderEditOrderProducts();

  // + Add Product button appended inside renderEditOrderProducts or here:
  const container = document.getElementById('editOrderProducts');
  const addBtn = document.createElement('button');
  addBtn.type = 'button';
  addBtn.textContent = '+ Add Product';
  addBtn.className = 'mt-4 bg-blue-600 text-white px-4 py-2 rounded';
  addBtn.onclick = openAddProductInOrderModal;
  container.appendChild(addBtn);

  document.getElementById('editOrderId').value = order_id;
  document.getElementById('editOrderModal').classList.remove('hidden');
}

// Close Edit Order Modal
function closeEditOrderModal() {
  document.getElementById('editOrderModal').classList.add('hidden');
}

// Render order products with qty and discount inputs and remove buttons
function renderEditOrderProducts() {
  const container = document.getElementById('editOrderProducts');
  container.innerHTML = '';
  currentEditOrder.items.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'flex items-center justify-between py-2 border-b';

    div.innerHTML = `
      <div class="flex-1 text-left">
        ${item.product_name}
      </div>

      <div class="flex items-center space-x-4">
        <div class="w-20 text-right">
          <label for="qty-${idx}" class="block text-xs font-semibold mb-1">Quantity</label>
          <input type="number" id="qty-${idx}" min="1" value="${item.quantity}" 
            class="border rounded p-1 w-full text-right" data-idx="${idx}" 
            onchange="editOrderQuantityChanged(this)">
        </div>

        <div class="w-20 text-right">
          <label for="discount-${idx}" class="block text-xs font-semibold mb-1">Final Price</label>
          <input type="number" id="discount-${idx}" min="0" max="100" value="${item.negotiated_price}" 
            class="border rounded p-1 w-full text-right" data-idx="${idx}" 
            onchange="editOrderDiscountChanged(this)">
        </div>

        <button type="button" onclick="removeProductFromEditOrder(${idx})" 
          class="bg-red-500 text-white px-2 py-1 rounded text-xs mt-6">
          Remove
        </button>
      </div>
    `;
    container.appendChild(div);
  });
}

// Quantity changed handler
function editOrderQuantityChanged(input) {
  const idx = +input.dataset.idx;
  currentEditOrder.items[idx].quantity = Math.max(1, parseInt(input.value) || 1);
}

// Discount % changed handler
function editOrderDiscountChanged(input) {
  const idx = +input.dataset.idx;
  currentEditOrder.items[idx].negotiated_price = Math.min(100, Math.max(0, parseFloat(input.value) || 0));
}

// Remove product from order
function removeProductFromEditOrder(idx) {
  currentEditOrder.items.splice(idx, 1);
  renderEditOrderProducts();
}

// Open Add Product In Order modal and populate product dropdown
async function openAddProductInOrderModal() {
  if (allProductsList.length === 0) {
    const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/products');
    allProductsList = await res.json();
  }
  const select = document.getElementById('addProductSelect');
  select.innerHTML = '<option value="">Select a product</option>';
  allProductsList.forEach(p => {
    if (!currentEditOrder.items.some(i => i.product_id === p.id)) {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name;
      select.appendChild(opt);
    }
  });

  document.getElementById('addProductQty').value = 1;
  document.getElementById('addProductDiscount').value = 0;
  document.getElementById('addProductInOrderModal').classList.remove('hidden');
}

// Close Add Product modal
function closeAddProductInOrderModal() {
  document.getElementById('addProductInOrderModal').classList.add('hidden');
}

// Add selected product from modal to order list
function addProductToOrderFromModal() {
  const productId = +document.getElementById('addProductSelect').value;
  if (!productId) {
    alert('Please select a product');
    return;
  }
  const quantity = Math.max(1, parseInt(document.getElementById('addProductQty').value) || 1);
  const discount = Math.min(100, Math.max(0, parseFloat(document.getElementById('addProductDiscount').value) || 0));

  const product = allProductsList.find(p => p.id === productId);
  if (!product) {
    alert('Invalid product selected');
    return;
  }

  currentEditOrder.items.push({
    product_id: product.id,
    product_name: product.name,
    quantity,
    negotiated_price: discount,
    unit_price: product.base_price
  });

  closeAddProductInOrderModal();
  renderEditOrderProducts();
}

// Save edited order by sending updated items to backend
async function saveEditedOrder() {
  const orderId = currentEditOrder.order_id;
  const itemsToSave = currentEditOrder.items.map(item => ({
    product_id: item.product_id,
    quantity: item.quantity,
    negotiated_price: item.negotiated_price
  }));

  try {
    const res = await fetch(`https://baba-merchant-store.onrender.com/api/admin/orders/${orderId}/items`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: itemsToSave })
    });

    if (res.ok) {
      alert('Order updated successfully!');

      // ✅ Refresh the order list to reflect changes
      await fetchOrders();

      // ✅ Close the modal after refresh
      closeEditOrderModal();

    } else {
      const err = await res.json();
      alert('Failed to update order: ' + (err.error || 'Unknown error'));
    }
  } catch (error) {
    console.error("Error saving edited order:", error);
    alert('Network error while updating order.');
  }
}
let salesSummaryData = null; // Store fetched data globally

async function fetchSalesSummaryData() {
  const response = await fetch('https://baba-merchant-store.onrender.com/api/admin/sales-summary/by-salesperson');
  salesSummaryData = await response.json();
}

function getChartDataForKPI(kpi) {
  if (!salesSummaryData) return {labels: [], data: []};
  const labels = salesSummaryData.map(d => d.salesperson_name);

  let data = [];
  switch (kpi) {
    case 'avgSalesPerOrder':
      data = salesSummaryData.map(d => {
        const num = Number(d.avg_sales_per_order);
        return isNaN(num) ? 0 : +num.toFixed(2);
      });
      break;
    case 'totalSales':
      data = salesSummaryData.map(d => {
        const num = Number(d.total_sales);
        return isNaN(num) ? 0 : +num.toFixed(2);
      });
      break;
    case 'totalOrders':
      data = salesSummaryData.map(d => Number(d.total_orders) || 0);
      break;
    case 'totalCustomers':
      data = salesSummaryData.map(d => Number(d.total_customers) || 0);
      break;
    default:
      data = [];
  }
  return {labels, data};
}

let salesSummaryChartInstance = null;

function renderSalesSummaryChartForKPI(kpi) {
  const {labels, data} = getChartDataForKPI(kpi);
  const ctx = document.getElementById('salesSummaryChart').getContext('2d');

  if (salesSummaryChartInstance) {
    salesSummaryChartInstance.destroy();
  }

  salesSummaryChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: getKPIDisplayName(kpi),
          data: data,
          backgroundColor: 'rgba(54, 162, 235, 0.7)'
        }
      ]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
}

function getKPIDisplayName(kpi) {
  switch (kpi) {
    case 'avgSalesPerOrder': return 'Avg Sales per Order';
    case 'totalSales': return 'Total Sales';
    case 'totalOrders': return 'Total Orders';
    case 'totalCustomers': return 'Total Customers';
    default: return '';
  }
}

document.addEventListener('DOMContentLoaded', async function() {
  await fetchSalesSummaryData();
  const kpiSelector = document.getElementById('kpiSelector');
  renderSalesSummaryChartForKPI(kpiSelector.value);

  kpiSelector.addEventListener('change', function() {
    renderSalesSummaryChartForKPI(this.value);
  });
});

let productsCache = []; // store products to avoid refetching

async function openCreateOrderModal() {
  await populateSalespersonDropdownForOrders();
  await populateRetailerDropdownForOrders();
  await loadProductsForOrders();
  document.getElementById("createOrderModal").classList.remove("hidden");
  document.getElementById("orderProductsContainer").innerHTML = ""; // reset
}

function closeCreateOrderModal() {
  document.getElementById("createOrderModal").classList.add("hidden");
}

// Fetch all products once
async function loadProductsForOrders() {
  if (productsCache.length > 0) return;
  const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/products', { credentials: 'include' });
  productsCache = await res.json();
}

// Add product row dynamically
function addProductRow() {
  const container = document.getElementById("orderProductsContainer");

  const row = document.createElement("div");
  row.className = "flex space-x-2 items-center";

  const productSelect = document.createElement("select");
  productSelect.className = "border p-2 rounded flex-1";
  productSelect.required = true;
  productSelect.innerHTML = '<option value="">-- Select Product --</option>';
  productsCache.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = `${p.name}`;
    productSelect.appendChild(opt);
  });

  const qtyInput = document.createElement("input");
  qtyInput.type = "number";
  qtyInput.placeholder = "Qty";
  qtyInput.className = "border p-2 rounded w-20";
  qtyInput.required = true;

  const priceInput = document.createElement("input");
  priceInput.type = "number";
  priceInput.step = "0.01";
  priceInput.placeholder = "Negotiated Price";
  priceInput.className = "border p-2 rounded w-32";
  priceInput.required = true;

  const removeBtn = document.createElement("button");
  removeBtn.type = "button";
  removeBtn.textContent = "x";
  removeBtn.className = "bg-red-500 text-white px-2 py-1 rounded";
  removeBtn.onclick = () => row.remove();

  row.appendChild(productSelect);
  row.appendChild(qtyInput);
  row.appendChild(priceInput);
  row.appendChild(removeBtn);

  container.appendChild(row);
}

// Save Order
document.getElementById("createOrderForm").addEventListener("submit", async (e) => {
  e.preventDefault();
});

async function saveCreatedOrder() {
  const salesperson_id = document.getElementById("orderSalesperson").value;
  const customerId = document.getElementById("orderRetailer").value;
  const notes = document.getElementById("orderNotes").value;

  // Collect product rows
  const items = [];
  document.querySelectorAll("#orderProductsContainer > div").forEach(row => {
    const product_id = row.querySelector("select").value;
    const quantity = row.querySelector("input[type='number']").value;
    const price = row.querySelector("input[placeholder='Negotiated Price']").value;
    if (product_id && quantity && price) {
      items.push({ product_id, quantity, negotiated_price: price });
    }
  });

  if (items.length === 0) {
    alert("Please add at least one product.");
    return;
  }

  const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/orders', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ salesperson_id, customer_id: customerId, notes, items })
  });

  if (res.ok) {
    alert("Order created successfully!");
    closeCreateOrderModal();
    fetchOrders();
  } else {
    const err = await res.json();
    alert("Failed to create order: " + (err.error || "Unknown error"));
  }
}

async function populateSalespersonDropdownForOrders() {
  try {
    const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/salespersons', { credentials: 'include' });
    let salespersons = await res.json();
    salespersons = salespersons.filter(sp => sp.status === 'active');

    const select = document.getElementById("orderSalesperson");
    if (!select) return;
    select.innerHTML = '<option value="">-- Select Salesperson --</option>';

    salespersons.forEach(sp => {
      const opt = document.createElement("option");
      opt.value = sp.id;
      opt.textContent = sp.name;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("Failed to load salespersons for orders:", err);
  }
}

async function populateRetailerDropdownForOrders() {
  try {
    const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/retailers', { credentials: 'include' });
    let retailers = await res.json();

    const select = document.getElementById("orderRetailer");
    if (!select) return;
    select.innerHTML = '<option value="">-- Select Retailer --</option>';

    retailers.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r.customer_id;  // make sure your backend returns "id" for retailers
      opt.textContent = `${r.name} (${r.customer_id || ''})`;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("Failed to load retailers for orders:", err);
  }
}

async function addProductRow() {
  const container = document.getElementById("orderProductsContainer");

  // Fetch products if not already cached
  if (!window._productsCache) {
    try {
      const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/products', { credentials: 'include' });
      window._productsCache = await res.json();
    } catch (err) {
      console.error("Failed to fetch products:", err);
      return;
    }
  }

  const row = document.createElement("div");
  row.className = "flex-1 min-w-0";
 

  // Product dropdown
  const productSelect = document.createElement("select");
  productSelect.className = "w-full border rounded p-2 truncate";
  productSelect.innerHTML = `<option value="">-- Select Product --</option>`;
  window._productsCache.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = `${p.name} (Min Price: ₹${p.min_price})`;
    productSelect.appendChild(opt);
  });

  // Quantity
  const qtyInput = document.createElement("input");
  qtyInput.type = "number";
  qtyInput.min = 1;
  qtyInput.placeholder = "Qty";
  qtyInput.className = "w-20 border rounded p-2";

  // Negotiated price
  const priceInput = document.createElement("input");
  priceInput.type = "number";
  priceInput.step = "0.01";
  priceInput.placeholder = "Final Price";
  priceInput.className = "w-32 border rounded p-2";

  // Remove button
  const removeBtn = document.createElement("button");
  removeBtn.type = "button";
  removeBtn.textContent = "X";
  removeBtn.className = "bg-red-500 text-white px-2 py-1 rounded";
  removeBtn.onclick = () => row.remove();

  row.appendChild(productSelect);
  row.appendChild(qtyInput);
  row.appendChild(priceInput);
  row.appendChild(removeBtn);

  container.appendChild(row);
}

async function openBulkReassignModal() {
  // Fetch salespersons from backend
  const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/salespersons');
  const salespersons = await res.json();

  const fromSelect = document.getElementById('fromSalesperson');
  const toSelect = document.getElementById('toSalesperson');
  fromSelect.innerHTML = '';
  toSelect.innerHTML = '';

  salespersons.forEach(sp => {
    const optFrom = document.createElement('option');
    optFrom.value = sp.id;
    optFrom.textContent = sp.name;
    fromSelect.appendChild(optFrom);

    const optTo = document.createElement('option');
    optTo.value = sp.id;
    optTo.textContent = sp.name;
    toSelect.appendChild(optTo);
  });

  document.getElementById('bulkReassignModal').classList.remove('hidden');
}

function closeBulkReassignModal() {
  document.getElementById('bulkReassignModal').classList.add('hidden');
}

async function bulkReassignRetailers() {
  const fromId = document.getElementById('fromSalesperson').value;
  const toId = document.getElementById('toSalesperson').value;
  if (!fromId || !toId || fromId === toId) {
    alert("Please select different salespersons.");
    return;
  }
  if (!confirm("Are you sure you want to reassign all retailers from this salesperson to the other?")) {
    return;
  }
  const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/retailers/bulk-reassign', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ fromSalespersonId: fromId, toSalespersonId: toId })
  });
  const result = await res.json();
  if (res.ok) {
    alert("Retailers reassigned successfully.");
    closeBulkReassignModal();
    loadRetailers(); // reload your retailers table
  } else {
    alert(result.error || "Failed to reassign retailers.");
  }
}



console.log('Admin dashboard script loaded');

  </script>
<!-- Add/Edit Product Modal -->
<div id="productModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <!-- outer container with max height -->
  <div class="bg-white w-full max-w-md max-h-[90vh] rounded shadow flex flex-col">
    
    <!-- Modal Title -->
    <h2 id="productModalTitle" class="text-lg font-bold p-4 border-b">Add Product</h2>
    
    <!-- Scrollable content -->
    <div class="flex-1 overflow-y-auto p-6">
      <form id="productForm" class="space-y-3">
        <input type="hidden" id="productId" />

        <div>
          <label class="block text-sm font-medium">Name</label>
          <input type="text" id="productName" required class="w-full p-2 border rounded mt-1" />
        </div>

        <div>
          <label class="block text-sm font-medium">Base Price</label>
          <input id="productBasePrice" type="number" placeholder="Base Price" class="w-full border px-3 py-2 rounded" />
        </div>

        <div>
          <label class="block text-sm font-medium">Min Retail Price</label>
          <input id="productMinRetailPrice" type="number" placeholder="Min Retail Price" class="w-full border px-3 py-2 rounded" />
        </div>

        <div>
          <label class="block text-sm font-medium">HSN Code</label>
          <input type="text" id="productHSN" class="w-full border rounded p-2" required />
        </div>

        <div>
          <label class="block text-sm font-medium">CGST (%)</label>
          <input type="number" step="0.01" id="productCGST" class="w-full border rounded p-2" required />
        </div>

        <div>
          <label class="block text-sm font-medium">SGST (%)</label>
          <input type="number" step="0.01" id="productSGST" class="w-full border rounded p-2" required />
        </div>

        <div>
          <label class="block text-sm font-medium">Cess (%)</label>
          <input type="number" step="0.01" id="productCess" class="w-full border rounded p-2" required />
        </div>

        <div>
          <label class="block text-sm font-medium">Company</label>
          <select id="productCompany" required class="w-full p-2 border rounded mt-1">
            <option value="">Select a company</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium">Image URL</label>
          <input type="url" id="productImage" required class="w-full p-2 border rounded mt-1" />
        </div>
      </form>
    </div>

    <!-- Footer (non-scrollable) -->
    <div class="flex justify-end space-x-2 p-4 border-t">
      <button type="button" onclick="closeProductModal()" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
      <button type="submit" form="productForm" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div class="bg-white w-full max-w-sm p-6 rounded shadow text-center">
    <h3 class="text-lg font-bold mb-2">Delete Product</h3>
    <p class="text-sm text-gray-600 mb-4">Are you sure you want to delete this product?</p>
    <div class="flex justify-center space-x-3">
      <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
      <button onclick="confirmDeleteProduct()" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
    </div>
  </div>
</div>

<!-- Salesperson Modal -->
<div id="addSalespersonModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div class="bg-white w-full max-w-md p-6 rounded shadow">
    <h2 id="salespersonModalTitle" class="text-lg font-bold mb-4">Add Salesperson</h2>
    <form id="salespersonForm">
      <input type="hidden" id="salespersonId" />

      <div class="mb-3">
        <label class="block text-sm font-medium">Name</label>
        <input type="text" id="salespersonName" required class="w-full p-2 border rounded mt-1" />
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium">Email</label>
        <input type="email" id="salespersonEmail" required class="w-full p-2 border rounded mt-1" />
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium">Phone</label>
        <input type="text" id="salespersonPhone" required class="w-full p-2 border rounded mt-1" />
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium">Password</label>
        <input type="password" id="salespersonPassword" required class="w-full p-2 border rounded mt-1" />
      </div>

      <div class="flex justify-end space-x-2 mt-4">
        <button type="button" onclick="closeModal('addSalespersonModal')" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
        <button onclick="saveSalesperson()" class="bg-green-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </form>
  </div>
</div>
<!-- Retailer Modal -->
<div id="addRetailerModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6">
    <h2 class="text-lg font-bold mb-4">Add Retailer</h2>
    <form id="addRetailerForm" class="space-y-3">
      <div>
        <label class="block text-sm">Retailer Name</label>
        <input type="text" id="retailerName" class="w-full border rounded p-2" required />
      </div>
      <div>
        <label class="block text-sm">Contact Number</label>
        <input type="text" id="retailerPhone" class="w-full border rounded p-2" required />
      </div>
      <div>
        <label class="block text-sm">Email</label>
        <input type="email" id="retailerEmail" class="w-full border rounded p-2" required />
      </div>
<div>
  <label class="block text-sm">Password</label>
  <input id="retailerPassword" type="password" class="w-full border rounded p-2" required>
</div>

      <div>
        <label class="block text-sm">Retailer ID</label>
        <input type="text" id="retailerId" class="w-full border rounded p-2" required />
      </div>

      <div>
        <label class="block text-sm">Area</label>
        <input type="text" id="retailerRegion" class="w-full border rounded p-2" required />
      </div>
      <div>
        <label class="block text-sm">Assign Salesperson</label>
        <select id="retailerSalesperson" class="w-full border rounded p-2" required>
          <!-- dynamically filled -->
        </select>
      </div>
      <div class="flex justify-end space-x-2 mt-4">
        <button type="button" onclick="closeAddRetailerModal()" class="px-3 py-1 rounded bg-gray-300">Cancel</button>
        <button type="submit" onclick="saveRetailer()" class="px-3 py-1 rounded bg-blue-600 text-white">Save</button>
      </div>
    </form>
  </div>
</div>
<!-- Company Modal -->
<div id="addCompanyModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div class="bg-white w-full max-w-md p-6 rounded shadow">
    <h2 id="companyModalTitle" class="text-lg font-bold mb-4">Add Company</h2>
    <form id="companyForm">
      <input type="hidden" id="companyId" />

      <div class="mb-3">
        <label class="block text-sm font-medium">Company Name</label>
        <input type="text" id="companyName" required class="w-full p-2 border rounded mt-1" />
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium">Logo URL</label>
        <input type="url" id="companyLogo" placeholder="https://example.com/logo.png" class="w-full p-2 border rounded mt-1" />
      </div>

      <div class="flex justify-end space-x-2 mt-4">
        <button type="button" onclick="closeModal('addCompanyModal')" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
        <button onclick="saveCompany()" class="bg-green-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </form>
  </div>
</div>
<div id="retailersModal" class="fixed inset-0 hidden bg-black bg-opacity-40 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow-lg w-full max-w-md">
    <h2 class="text-lg font-bold mb-3">Assigned Retailers</h2>
    <ul id="retailersList" class="list-disc list-inside mb-4"></ul>
    <button onclick="closeRetailersModal()" class="bg-gray-500 text-white px-4 py-2 rounded">Close</button>
  </div>
</div>
<div id="editCompanyModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6">
    <h2 class="text-lg font-bold mb-4">Edit Company</h2>
    <form id="editCompanyForm" class="space-y-3">
      <input type="hidden" id="editCompanyId" />
      <div>
        <label class="block text-sm">Company Name</label>
        <input type="text" id="editCompanyName" class="w-full border rounded p-2" required />
      </div>
      <div>
        <label class="block text-sm">Logo URL</label>
        <input type="url" id="editCompanyLogoUrl" class="w-full border rounded p-2" />
      </div>
      <div class="flex justify-end space-x-2 mt-4">
        <button type="button" onclick="closeEditCompanyModal()" 
                class="px-3 py-1 rounded bg-gray-300">Cancel</button>
        <button id="saveEditCompanyBtn" 
                type="button" 
                class="px-3 py-1 rounded bg-blue-600 text-white">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Salesperson Modal -->
<div id="editSalespersonModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6">
    <h2 class="text-lg font-bold mb-4">Edit Salesperson</h2>
    <form id="editSalespersonForm" class="space-y-3">
      <input type="hidden" id="editSalespersonId" />

      <div>
        <label class="block text-sm">Name</label>
        <input type="text" id="editSalespersonName" class="w-full border rounded p-2" required />
      </div>

      <div>
        <label class="block text-sm">Email</label>
        <input type="email" id="editSalespersonEmail" class="w-full border rounded p-2" required />
      </div>

      <div>
        <label class="block text-sm">Phone</label>
        <input type="text" id="editSalespersonPhone" class="w-full border rounded p-2" />
      </div>

      <div class="flex justify-end space-x-2 mt-4">
        <button type="button" onclick="closeEditSalespersonModal()" 
                class="px-3 py-1 rounded bg-gray-300">Cancel</button>
<button id="saveEditSalespersonBtn" 
        type="button" 
        class="px-3 py-1 rounded bg-blue-600 text-white">Save</button>

      </div>
    </form>
  </div>
</div>
<!-- ✅ Edit Retailer Modal -->
<div id="editRetailerModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6">
    <h2 class="text-lg font-bold mb-4">Edit Retailer</h2>
    <form id="editRetailerForm" class="space-y-3">
      <input type="hidden" id="editRetailerId" />

      <div>
        <label class="block text-sm">Retailer Name</label>
        <input type="text" id="editRetailerName" class="w-full border rounded p-2" required />
      </div>

      <div>
        <label class="block text-sm">Contact Number</label>
        <input type="text" id="editRetailerPhone" class="w-full border rounded p-2" />
      </div>

      <div>
        <label class="block text-sm">Email</label>
        <input type="email" id="editRetailerEmail" class="w-full border rounded p-2" />
      </div>

      <div>
        <label class="block text-sm">Retailer ID</label>
        <input type="text" id="editRetailerRetailerId" class="w-full border rounded p-2" />
      </div>

      <div>
        <label class="block text-sm">Area</label>
        <input type="text" id="editRetailerRegion" class="w-full border rounded p-2" />
      </div>

      <div>
        <label class="block text-sm">Assign Salesperson</label>
        <select id="editRetailerSalesperson" class="w-full border rounded p-2">
          <!-- dynamically filled -->
        </select>
      </div>

      <div class="flex justify-end space-x-2 mt-4">
        <button type="button" onclick="closeEditRetailerModal()" 
                class="px-3 py-1 rounded bg-gray-300">Cancel</button>
        <button type="button" onclick="saveEditedRetailer()" 
                class="px-3 py-1 rounded bg-blue-600 text-white">Save</button>
      </div>
    </form>
  </div>
</div>
<div id="editOrderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-xl max-h-[90vh] overflow-auto">
    <h2 class="text-xl font-bold mb-4">Edit Order</h2>
    <form id="editOrderForm">
      <input type="hidden" id="editOrderId" />
      <div id="editOrderProducts" class="space-y-2 mb-4"></div>
      <div class="flex justify-end mt-4 space-x-2">
        <button type="button" onclick="closeEditOrderModal()" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
        <button type="button" onclick="saveEditedOrder()" class="bg-green-600 text-white px-4 py-2 rounded">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<div id="addProductInOrderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
    <h2 class="text-xl font-bold mb-4">Add Product to Order</h2>
    <form id="addProductForm">
      <label class="block mb-1 font-semibold" for="addProductSelect">Product</label>
      <select id="addProductSelect" class="border rounded p-2 w-full mb-3"></select>

      <label class="block mb-1 font-semibold" for="addProductQty">Quantity</label>
      <input type="number" id="addProductQty" min="1" value="1" class="border rounded p-2 w-full mb-3"/>

      <label class="block mb-1 font-semibold" for="addProductDiscount">Final Price</label>
      <input type="number" id="addProductDiscount" min="0" max="100" value="0" class="border rounded p-2 w-full mb-4"/>

      <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeAddProductInOrderModal()" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
        <button type="button" onclick="addProductToOrderFromModal()" class="bg-green-600 text-white px-4 py-2 rounded">Add</button>
      </div>
    </form>
  </div>
</div>
<!-- Create Order Modal -->
<div id="createOrderModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-[600px] p-6">
    <h2 class="text-lg font-bold mb-4 text-orange-700">Create New Order</h2>
    <form id="createOrderForm" class="space-y-3">
      
      <!-- Salesperson -->
      <div>
        <label class="block text-sm">Assign Salesperson</label>
        <select id="orderSalesperson" class="w-full border rounded p-2" required></select>
      </div>

      <!-- Retailer -->
      <div>
        <label class="block text-sm">Select Retailer</label>
        <select id="orderRetailer" class="w-full border rounded p-2" required></select>
      </div>

      <!-- Products Section -->
<!-- Products Section -->
<div class="mt-4">
  <label class="block text-sm font-medium mb-2">Products</label>
  <div id="orderProductsContainer" class="space-y-2">
    <!-- Product rows will be added here -->
  </div>
  <button type="button" onclick="addProductRow()" 
    class="mt-2 px-3 py-1 bg-green-600 text-white rounded shadow">
    + Add Product
  </button>
</div>


      <!-- Notes -->
      <div>
        <label class="block text-sm">Notes</label>
        <textarea id="orderNotes" class="w-full border rounded p-2"></textarea>
      </div>

      <div class="flex justify-end space-x-2 mt-4">
        <button type="button" onclick="closeCreateOrderModal()" 
          class="px-3 py-1 rounded bg-gray-300">Cancel</button>

<button type="button" onclick="saveCreatedOrder()" class="px-3 py-1 rounded bg-orange-600 text-white">Save Order</button>

      </div>
    </form>
  </div>
</div>
<div id="bulkReassignModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
    <h2 class="text-xl font-bold mb-4">Bulk Reassign Retailers</h2>
    <form>
      <label class="block mb-1 font-semibold">From Salesperson</label>
      <select id="fromSalesperson" class="border rounded p-2 w-full mb-4"></select>
      <label class="block mb-1 font-semibold">To Salesperson</label>
      <select id="toSalesperson" class="border rounded p-2 w-full mb-4"></select>
      <div class="flex justify-end space-x-2 mt-3">
        <button type="button" onclick="closeBulkReassignModal()" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
        <button type="button" onclick="bulkReassignRetailers()" class="bg-green-600 text-white px-4 py-2 rounded">Reassign All</button>
      </div>
    </form>
  </div>
</div>




<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
function openModal(id) {
  document.getElementById(id).classList.remove('hidden');
}

function closeModal(id) {
  document.getElementById(id).classList.add('hidden');
}

async function saveSalesperson() {
  const name = document.getElementById('salespersonName').value;
  const email = document.getElementById('salespersonEmail').value;
  const phone = document.getElementById('salespersonPhone').value;
  const password = document.getElementById('salespersonPassword').value;

  if (!name || !email || !phone || !password) {
    alert("Please fill all fields");
    return;
  }

  const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/salespersons', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, email, phone, password })
  });

  const data = await res.json();
  if (res.ok) {
    alert("Salesperson added successfully");
    closeModal('addSalespersonModal');
    loadSalespersons();
  } else {
    alert(data.error || "Error adding salesperson");
  }
}
async function saveRetailer() {
  const name = document.getElementById('retailerName').value;
  const phone = document.getElementById('retailerPhone').value;
  const email = document.getElementById('retailerEmail').value;
  const password = document.getElementById('retailerPassword').value.trim();
  const region = document.getElementById('retailerRegion').value;
  const salesperson_id = document.getElementById('retailerSalesperson').value;
  const customer_id = document.getElementById('retailerId').value; // optional

  if (!name || !phone || !email || !salesperson_id || !password || !region) {
    alert("Please fill all required fields");
    return;
  }

  try {
    const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/retailers', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        name, 
        phone, 
        email,
        password, 
        region,
        salesperson_id, 
        customer_id: customer_id
      })
    });

    const data = await res.json();

    if (res.ok) {
      alert("Retailer added successfully");
      closeModal('addRetailerModal');
      loadRetailers(); // refresh table
    } else {
      alert(data.error || "Error adding retailer");
    }
  } catch (err) {
    console.error("Error saving retailer:", err);
    alert("Error saving retailer");
  }
}

async function saveCompany() {
  const name = document.getElementById('companyName').value;
  const logo_url = document.getElementById('companyLogo').value;

  if (!name) {
    alert("Please fill company name");
    return;
  }

  const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/companies', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, logo_url })
  });

  const data = await res.json();
  if (res.ok) {
    alert("Company added successfully");
    closeModal('addCompanyModal');
    loadCompanies();
  } else {
    alert(data.error || "Error adding company");
  }
}

async function loadSalespersons() {
  try {
    const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/salespersons', { credentials: 'include' });
    let salespersons = await res.json();

    // Only show active salespersons
    salespersons = salespersons.filter(sp => sp.status === 'active');

    const tbody = document.querySelector("#salespersonTable");
    tbody.innerHTML = "";

    salespersons.forEach(sp => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="px-4 py-2 border">${sp.name}</td>
        <td class="px-4 py-2 border">${sp.email}</td>
        <td class="px-4 py-2 border">
          <button class="bg-gray-200 hover:bg-gray-300 text-black px-2 py-1 rounded text-xs"
                  onclick="viewRetailers(${sp.id}, '${sp.name}')">
            View Retailers
          </button>
        </td>
        <td class="px-4 py-2 border flex space-x-2">
          <button class="bg-yellow-500 text-white px-2 py-1 rounded text-xs"
                  onclick="openEditSalespersonModal(${sp.id}, '${sp.name}', '${sp.email}', '${sp.phone}')">
            Edit
          </button>
          <button class="bg-red-500 text-white px-2 py-1 rounded text-xs"
                  onclick="deleteSalesperson(${sp.id})">
            Delete
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("Error loading salespersons:", err);
  }
}
async function deleteSalesperson(id) {
  if (!confirm("Are you sure you want to delete this salesperson?")) return;
  await fetch(`https://baba-merchant-store.onrender.com/api/admin/salespersons/${id}`, { method: "DELETE" });
  loadSalespersons();
}
// Attach event listener to Save button
document.getElementById("saveEditSalespersonBtn").addEventListener("click", async () => {
  const id = document.getElementById("editSalespersonId").value;
  const name = document.getElementById("editSalespersonName").value.trim();
  const email = document.getElementById("editSalespersonEmail").value.trim();
  const phone = document.getElementById("editSalespersonPhone").value.trim();

  if (!name || !email) {
    alert("Name and email are required.");
    return;
  }

  try {
    const res = await fetch(`https://baba-merchant-store.onrender.com/api/admin/salespersons/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, email, phone })
    });

    if (res.ok) {
      closeEditSalespersonModal();
      loadSalespersons(); // Refresh table
    } else {
      const err = await res.json();
      alert("Failed to update salesperson: " + (err.error || "Unknown error"));
    }
  } catch (error) {
    console.error("Error updating salesperson:", error);
    alert("Something went wrong while updating.");
  }
});


async function loadRetailers() {
  try {
    const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/retailers', { credentials: 'include' });
    let retailers = await res.json();

    // Refresh area filter list
    populateAreaFilter(retailers);

    const tbody = document.getElementById("retailerTable");
    tbody.innerHTML = "";

    // Get the actually selected regions
    const selectedAreas = getSelectedAreas();  

    retailers.forEach(r => {
      if (selectedAreas.length === 0 || selectedAreas.includes((r.region || '').trim())) {
        const tr = document.createElement("tr");
        tr.setAttribute("data-region", r.region || '');
        tr.innerHTML = `
          <td class="px-4 py-2 border">${r.name}</td>
          <td class="px-4 py-2 border">${r.phone || '-'}</td>
          <td class="px-4 py-2 border">${r.email || '-'}</td>
          <td class="px-4 py-2 border">${r.customer_id}</td>
          <td class="px-4 py-2 border">${r.salesperson_name || 'Unassigned'}</td>
          <td class="px-4 py-2 border flex space-x-2">
            <button class="bg-yellow-500 text-white px-2 py-1 rounded text-xs" 
                    onclick="openEditRetailerModal(${r.id}, '${r.name}', '${r.phone}', '${r.email}', '${r.customer_id}', '${r.region}', '${r.salesperson_id}')">
              Edit
            </button>
            <button class="bg-red-500 text-white px-2 py-1 rounded text-xs" 
                    onclick="deleteRetailer(${r.id})">
              Delete
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    });
  } catch (err) {
    console.error("Error loading retailers:", err);
  }
}

const areaState = {
  all: [],            // all available regions
  selected: new Set() // chosen regions
};

// Populate the Area list (tries https://baba-merchant-store.onrender.com/api/admin/regions, falls back to unique regions from retailers)
async function populateAreaFilter() {
  try {
    let regions = [];

    // Try dedicated regions endpoint if you have it
    try {
      const r = await fetch('https://baba-merchant-store.onrender.com/api/admin/retailers', { credentials: 'include' });
      if (r.ok) {
        const data = await r.json();
        // handle both ['North','South'] or [{region:'North'}] shapes
        regions = Array.isArray(data)
          ? data.map(x => (typeof x === 'string' ? x : (x.region || x.name))).filter(Boolean)
          : [];
      }
    } catch { /* ignore and fallback below */ }

    // Fallback: derive distinct regions from retailers
    if (!regions || regions.length === 0) {
      const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/retailers', { credentials: 'include' });
      const retailers = await res.json();
      regions = [...new Set(retailers.map(r => (r.region || '').trim()).filter(Boolean))];
    }

    areaState.all = regions.sort((a, b) => a.localeCompare(b));
    renderAreaDropdownList(areaState.all);
    renderAreaChips(); // initial empty selection
  } catch (err) {
    console.error('populateAreaFilter failed:', err);
  }
}

// Open/close dropdown
function toggleAreaDropdown(forceShow) {
  const dd = document.getElementById('areaDropdown');
  if (!dd) return;

  if (forceShow === true) dd.classList.remove('hidden');
  else if (forceShow === false) dd.classList.add('hidden');
  else dd.classList.toggle('hidden');
}

// Filter list as user types
function filterAreaList() {
  const input = document.getElementById('areaSearchInput');
  const term = (input?.value || '').toLowerCase();
  const filtered = areaState.all.filter(a => a.toLowerCase().includes(term));
  renderAreaDropdownList(filtered);
}

// Render dropdown options
function renderAreaDropdownList(list) {
  const dd = document.getElementById('areaDropdown');
  if (!dd) return;
  dd.innerHTML = '';

  if (!list || list.length === 0) {
    dd.innerHTML = `<div class="px-3 py-2 text-gray-500">No matches</div>`;
    return;
  }

  list.forEach(area => {
    const row = document.createElement('div');
    row.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer flex items-center justify-between';
    row.onclick = (e) => { e.stopPropagation(); toggleArea(area); };

    const label = document.createElement('span');
    label.textContent = area;

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = areaState.selected.has(area);
    cb.onclick = (e) => { e.stopPropagation(); toggleArea(area); };

    row.appendChild(label);
    row.appendChild(cb);
    dd.appendChild(row);
  });
}

// Add/remove area from selection
function toggleArea(area) {
  if (areaState.selected.has(area)) areaState.selected.delete(area);
  else areaState.selected.add(area);

  renderAreaChips();
  filterAreaList(); // refresh checkboxes
  // Refilter retailer table whenever selection changes
  if (typeof loadRetailers === 'function') loadRetailers();
}

// Render chips inside the multiselect container
function renderAreaChips() {
  const box = document.getElementById('areaMultiSelect');
  const input = document.getElementById('areaSearchInput');
  if (!box || !input) return;

  // remove existing chips
  box.querySelectorAll('.area-chip').forEach(el => el.remove());

  // add chips for selected areas
  [...areaState.selected].forEach(area => {
    const chip = document.createElement('span');
    chip.className = 'area-chip inline-flex items-center bg-blue-100 text-blue-700 text-xs rounded px-2 py-1';
    chip.innerHTML = `
      <span class="mr-1">${area}</span>
      <button type="button" class="ml-1 text-blue-700 hover:text-blue-900" aria-label="remove">&times;</button>
    `;
    chip.querySelector('button').onclick = (e) => {
      e.stopPropagation();
      areaState.selected.delete(area);
      renderAreaChips();
      filterAreaList();
      if (typeof loadRetailers === 'function') loadRetailers();
    };
    box.insertBefore(chip, input);
  });
}

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
  const wrapper = document.getElementById('areaMultiSelect')?.parentElement; // container that holds input + dropdown
  const dd = document.getElementById('areaDropdown');
  if (!wrapper || !dd) return;

  if (!wrapper.contains(e.target)) {
    toggleAreaDropdown(false);
  }
});

// Optional: handle Backspace to remove last chip when input empty
document.addEventListener('keydown', (e) => {
  const input = document.getElementById('areaSearchInput');
  if (!input || document.activeElement !== input) return;

  if (e.key === 'Backspace' && input.value === '' && areaState.selected.size > 0) {
    const last = [...areaState.selected].pop();
    areaState.selected.delete(last);
    renderAreaChips();
    filterAreaList();
    if (typeof loadRetailers === 'function') loadRetailers();
  }
});

// Helper to use in loadRetailers()
function getSelectedAreas() {
  return [...areaState.selected];
}

async function populateSalespersonDropdown() {
  try {
    const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/salespersons', { credentials: 'include' });
    let salespersons = await res.json();
    console.log("Salespersons API response:", salespersons);
    salespersons = salespersons.filter(sp => sp.status === 'active');

    const select = document.getElementById("retailerSalesperson");
    console.log("Dropdown element:", select);
    select.innerHTML = '<option value="">-- Select --</option>';
    salespersons.forEach(sp => {
      const opt = document.createElement("option");
      opt.value = sp.id;
      opt.textContent = sp.name;
      console.log("Appending option:", opt);  
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("Failed to load salespersons:", err);
  }
}

function openAddRetailerModal() {
  console.log("Opening Add Retailer modal");
  populateSalespersonDropdown();
  document.getElementById("addRetailerModal").classList.remove("hidden");
}

function closeAddRetailerModal() {
  document.getElementById("addRetailerModal").classList.add("hidden");
}

async function openEditRetailerModal(id, name, phone, email, customer_id, region, salesperson_id) {
  document.getElementById("editRetailerId").value = id;
  document.getElementById("editRetailerName").value = name;
  document.getElementById("editRetailerPhone").value = phone;
  document.getElementById("editRetailerEmail").value = email;
  document.getElementById("editRetailerRetailerId").value = customer_id;
  document.getElementById("editRetailerRegion").value = region;

  // populate salesperson dropdown
  const select = document.getElementById("editRetailerSalesperson");
  select.innerHTML = '<option value="">-- Select --</option>';
  const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/salespersons', { credentials: 'include' });
  let salespersons = await res.json();
  salespersons = salespersons.filter(sp => sp.status === "active");
  salespersons.forEach(sp => {
    const opt = document.createElement("option");
    opt.value = sp.id;
    opt.textContent = sp.name;
    if (sp.id == salesperson_id) opt.selected = true;
    select.appendChild(opt);
  });

  document.getElementById("editRetailerModal").classList.remove("hidden");
}

function closeEditCompanyModal() {
  document.getElementById('editCompanyModal').classList.add('hidden');
}

function openEditCompanyModal(company) {
  document.getElementById('editCompanyId').value = company.id;
  document.getElementById('editCompanyName').value = company.name || '';
  document.getElementById('editCompanyLogoUrl').value = company.logo_url || '';
  document.getElementById('editCompanyModal').classList.remove('hidden');
}

document.getElementById('saveEditCompanyBtn').addEventListener('click', async () => {
  const id = document.getElementById('editCompanyId').value;
  const name = document.getElementById('editCompanyName').value;
  const logo_url = document.getElementById('editCompanyLogoUrl').value;

  if (!name) {
    alert('Company name is required.');
    return;
  }

  try {
    const response = await fetch(`https://baba-merchant-store.onrender.com/api/admin/companies/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, logo_url })
    });

    if (response.ok) {
      alert('Company updated successfully!');
      closeEditCompanyModal();
      loadCompanies(); // Refresh your companies list
    } else {
      const errorData = await response.json();
      alert('Failed to update company: ' + (errorData.error || 'Unknown error'));
    }
  } catch (error) {
    alert('Error updating company: ' + error.message);
  }
});


async function saveEditedRetailer() {
  const id = document.getElementById("editRetailerId").value;
  const name = document.getElementById("editRetailerName").value;
  const phone = document.getElementById("editRetailerPhone").value;
  const email = document.getElementById("editRetailerEmail").value;
  const region = document.getElementById("editRetailerRegion").value;
  const customer_id = document.getElementById("editRetailerRetailerId").value;
  const salesperson_id = document.getElementById("editRetailerSalesperson").value;

  const res = await fetch(`https://baba-merchant-store.onrender.com/api/admin/retailers/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, phone, email, customer_id, region, salesperson_id })
  });

  if (res.ok) {
    alert("Retailer updated!");
    closeEditRetailerModal();
    loadRetailers();
  } else {
    alert("Error updating retailer");
  }
}

async function deleteRetailer(id) {
  
  if (!id) {
    alert("No retailer selected.");
    return;
  }

  if (!confirm("Are you sure you want to delete this retailer?")) return;

  try {
    const res = await fetch(`https://baba-merchant-store.onrender.com/api/admin/retailers/${id}`, {
      method: "DELETE",
    });

    if (res.ok) {
      alert("Retailer deleted!");
      closeEditRetailerModal();  // <--- Close the modal here
      loadRetailers();           // Refresh the retailers list
    } else {
      const err = await res.json();
      alert("Delete failed: " + (err.error || "Unknown error"));
    }
  } catch (error) {
    alert("Delete failed: " + error.message);
  }
}


async function viewRetailers(salespersonId) {
  try {
    const res = await fetch(`https://baba-merchant-store.onrender.com/api/admin/salespersons/${salespersonId}/retailers`);
    const retailers = await res.json();
    const list = document.getElementById("retailersList");
    list.innerHTML = "";
    if (retailers.length === 0) {
      list.innerHTML = "<li class='text-gray-500'>No retailers assigned</li>";
    } else {
      retailers.forEach(r => {
        const li = document.createElement("li");
        li.className = "p-2 border rounded bg-gray-50";
        li.innerHTML = `
          <div class="font-medium">${r.name}</div>
          <div class="text-sm text-gray-600">📧 ${r.email || "N/A"}</div>
          <div class="text-sm text-gray-600">📞 ${r.phone || "N/A"}</div>
        `;
        list.appendChild(li);
      });
    }
    document.getElementById("retailersModal").classList.remove("hidden");
  } catch (err) {
    console.error("Failed to load retailers:", err);
  }
}
function closeRetailersModal() {
  document.getElementById("retailersModal").classList.add("hidden");
}

function closeEditRetailerModal() {
  document.getElementById("editRetailerModal").classList.add("hidden");
}


async function loadCompanies() {
  const res = await fetch('https://baba-merchant-store.onrender.com/api/admin/companies');
  const companies = await res.json();
  const tbody = document.getElementById('companyTable');
  tbody.innerHTML = '';

  companies.forEach(company => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-4 py-2 border">${company.name}</td>
      <td><img src="${company.logo_url}" class="h-8"></td>
      <td class="px-4 py-2 border flex space-x-2"></td>
    `;

    const editBtn = document.createElement('button');
    editBtn.className = 'bg-yellow-500 text-white px-2 py-1 rounded text-xs';
    editBtn.textContent = 'Edit';
    editBtn.addEventListener('click', () => openEditCompanyModal(company));

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'bg-red-500 text-white px-2 py-1 rounded text-xs';
    deleteBtn.textContent = 'Delete';
    deleteBtn.addEventListener('click', () => deleteCompany(company.id));

    const actionsTd = tr.children[2];
    const editWrapper = document.createElement('div');
    editWrapper.appendChild(editBtn);
    const deleteWrapper = document.createElement('div');
    deleteWrapper.appendChild(deleteBtn);

    actionsTd.appendChild(editWrapper);
    actionsTd.appendChild(deleteWrapper);

    tbody.appendChild(tr);
  });
}

async function deleteCompany(companyId) {
  if (!confirm("Are you sure you want to delete this company?")) return;

  try {
    const res = await fetch(`https://baba-merchant-store.onrender.com/api/admin/companies/${companyId}`, {
      method: 'DELETE'
    });

    if (res.ok) {
      alert("Company deleted successfully!");
      loadCompanies(); // refresh the table
      closeEditCompanyModal(); // if modal is open
    } else {
      const err = await res.json();
      alert("Error deleting company: " + (err.error || "Unknown error"));
    }
  } catch (error) {
    alert("Network error: " + error.message);
  }
}


document.addEventListener('DOMContentLoaded', () => {
  loadSalespersons();
  loadRetailers();
  loadCompanies();
});

function openEditSalespersonModal(id, name, email, phone) {
  document.getElementById("editSalespersonId").value = id;
  document.getElementById("editSalespersonName").value = name;
  document.getElementById("editSalespersonEmail").value = email;
  document.getElementById("editSalespersonPhone").value = phone;
  document.getElementById("editSalespersonModal").classList.remove("hidden");
}
function closeEditSalespersonModal() {
  document.getElementById("editSalespersonModal").classList.add("hidden");
}
async function saveSalespersonChanges() {
  const id = document.getElementById("editSalespersonId").value;
  const name = document.getElementById("editSalespersonName").value;
  const email = document.getElementById("editSalespersonEmail").value;
  const phone = document.getElementById("editSalespersonPhone").value;

  await fetch(`https://baba-merchant-store.onrender.com/api/admin/salespersons/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, email, phone })
  });
  closeEditSalespersonModal();
  loadSalespersons();
}



</script>



</body>
</html>
